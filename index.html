<!DOCTYPE html>
<html>

<head>
    <title>____________Model Viewer_________</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            width: 100%;
            height: 100%
        }

        div {
            position: absolute;
            top: 0;
        }
        #loader{
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: url('loader.gif') 
                        50% 50% no-repeat rgb(249,249,249);
            background-size: 10%;
            background-color: #D2A838;
        }
    </style>
</head>

<body>
        <div id="loader"></div>
    
    <script src="three.js"></script>
    <script src="GLTFLoader.js"></script>
    <script src="Stats.js"></script>
    <script src="gsap.js"></script>

    <script>
        var mixer, historyMixer, hudMixer, productMixer, selectedProduct, selecttionCoordinates, currentProductIndex, nextProductName;
        var clock = new THREE.Clock();
        // Load 3D Scene
        var scene = new THREE.Scene();

        // Load Camera Perspektive
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.x = -1
        camera.position.y = 6
        camera.position.z = 30
        camera.lookAt(new THREE.Vector3(1,6,-20));

        // Load a Renderer
        var renderer = new THREE.WebGLRenderer({
            alpha: false
        });
        renderer.setClearColor(0xC5C5C3);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.physicallyCorrectLights = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1;
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.body.appendChild(renderer.domElement);


        // raycaster and pointer objects
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        // Stats object to display frame rate
        var stats = new Stats();
        document.body.appendChild(stats.domElement);

        /*----------------------------------  Lights ------------------------------------*/

        // Adding Ambient light
        hlight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(hlight);

        // Adding Heisphere light
        const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
        hemiLight.position.set( 0, 100, 0 );
        scene.add( hemiLight );
        
        // Adding directional light
        const dirLight = new THREE.DirectionalLight( 0xffffff, 0.15);
        dirLight.position.set( - 0, 40, 50 );
        dirLight.castShadow = true;
        dirLight.shadow.camera.top = 50;
        dirLight.shadow.camera.bottom = - 25;
        dirLight.shadow.camera.left = - 25;
        dirLight.shadow.camera.right = 25;
        dirLight.shadow.camera.near = 0.1;
        dirLight.shadow.camera.far = 200;
        dirLight.shadow.mapSize.set( 1024, 1024 );
        scene.add( dirLight );

        /*----------------------------------  Arrow Helper ------------------------------------*/

        // ARROW HELPER
        var yAxis = new THREE.ArrowHelper(
            // first argument is the direction
            new THREE.Vector3(0, 2, 0).normalize(),
            // second argument is the origin
            new THREE.Vector3(0, 0, 0),
            // length
            25,
            // color
            0xFFFF00);
        scene.add(yAxis);

        // ARROW HELPER
        var xAxis = new THREE.ArrowHelper(
            // first argument is the direction
            new THREE.Vector3(2, 0, 0).normalize(),
            // second argument is the origin
            new THREE.Vector3(0, 0, 0),
            // length
            25,
            // color
            0x00ff00);
        scene.add(xAxis);

        // ARROW HELPER
        var zAxis = new THREE.ArrowHelper(
            // first argument is the direction
            new THREE.Vector3(0, 0, 2).normalize(),
            // second argument is the origin
            new THREE.Vector3(0, 0, 0),
            // length
            25,
            // color
            0x0000FF);
        scene.add(zAxis);


        /*---------------------------------- Loading ------------------------------------*/

        const manager = new THREE.LoadingManager();
        var loaderElement = document.getElementById("loader");
        manager.onStart = () => {
            console.log("loading ... ");
        }
        manager.onLoad = () => {
            loaderElement.style.display = 'none';
            console.log("Scene loaded");
        }


        /*----------------------------------  Load GLTF models ------------------------------------*/

        // glTf 2.0 Loader
        var loader = new THREE.GLTFLoader(manager);
        var gltfObject;
        loader.load('gltf_model/Int-static-v2.gltf', function (gltf) {
            gltfObject = gltf.scene;
            gltf.scene.scale.set(2, 2, 2);
            gltf.scene.position.x = 0; //Position (x = right+ left-)
            gltf.scene.position.y = 0; //Position (y = up+, down-)
            gltf.scene.position.z = 0; //Position (z = front +, back-)

            scene.add(gltf.scene);
        });

        // glTf 2.0 Loader
        var loader = new THREE.GLTFLoader();
        var gltfObject;
        loader.load('gltf_model/Int-anim-v1.gltf', function (gltf) {
            gltfObject = gltf.scene;
            gltf.scene.scale.set(2, 2, 2);
            gltf.scene.position.x = 0; //Position (x = right+ left-)
            gltf.scene.position.y = 0; //Position (y = up+, down-)
            gltf.scene.position.z = 0; //Position (z = front +, back-)
            mixer = new THREE.AnimationMixer(gltf.scene);
            gltf.animations.forEach((clip) => {
                mixer.clipAction(clip).play();
            });

            scene.add(gltf.scene);
        });

        var productsGltfObject;
        var loader1 = new THREE.GLTFLoader();
        loader1.load('gltf_model/Products-v2(withoutHUD).gltf', function (gltf) {
            productsGltfObject = gltf.scene;
            gltf.scene.scale.set(2, 2, 2);
            gltf.scene.position.x = 0; //Position (x = right+ left-)
            gltf.scene.position.y = 0; //Position (y = up+, down-)
            gltf.scene.position.z = 0; //Position (z = front +, back-)

            productMixer = new THREE.AnimationMixer(gltf.scene);
            gltf.animations.forEach((clip) => {
                productMixer.clipAction(clip).play();
            });

            scene.add(gltf.scene);
        });

        var loader2 = new THREE.GLTFLoader();
        loader2.load('gltf_model/Products-v2HUD.gltf', function (gltf) {
            gltfObject = gltf.scene;
            gltf.scene.scale.set(2, 2, 2);
            gltf.scene.position.x = 0; //Position (x = right+ left-)
            gltf.scene.position.y = 0; //Position (y = up+, down-)
            gltf.scene.position.z = 0; //Position (z = front +, back-)

            hudMixer = new THREE.AnimationMixer(gltf.scene);
            gltf.animations.forEach((clip) => {
                hudMixer.clipAction(clip).play();
            });

            scene.add(gltf.scene);
        });

        /*----------------------------------  GLTF model loading end ------------------------------------*/

        function animate() {
            stats.update();
            requestAnimationFrame(animate);
            var delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            if (hudMixer) hudMixer.update(delta);
            if (productMixer) productMixer.update(delta);
            render();
        }

        function render() {
            var delta = clock.getDelta();
            // camControls.update(delta);
            renderer.render(scene, camera);
        }
        render();
        animate();

        /*----------------------------------  Mouse Click ------------------------------------*/

        // creating camera standing postion
        const standing_position = {
            "C210R-001":{"x":-7,"y":3,"z":9.5},
            "C210R-002":{"x":-6,"y":3,"z":-3},
            "P300R001":{"x":4,"y":3.5,"z":-3},
            "P300R":{"x":5,"y":4,"z":9},
            "P300R002":{"x":5,"y":4,"z":21}
        }

        // pointer click event to teleport
        document.addEventListener('pointerup', onPointerclick);

        function onPointerclick(event) {
            pointer.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            pointer.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);

            // See if the ray from the camera into the world hits one of our meshes
            const intersects = raycaster.intersectObject(productsGltfObject, true);
            selecttionCoordinates = intersects[0].point;
            
            if (intersects[0].object.name in standing_position){
                currentProductIndex = Object.keys(standing_position).findIndex(x => x === intersects[0].object.name);
                gsap.to(camera.position,{
                    duration:3,
                    x : standing_position[intersects[0].object.name].x,
                    y:  standing_position[intersects[0].object.name].y,
                    z:  standing_position[intersects[0].object.name].z,
                    onUpdate: () => {
                        camera.lookAt( intersects[0].point );
                    }
                });
                
            }
        
            console.log(intersects[0].object.name);
        }


        document.addEventListener("keydown", onDocumentKeyDown);
        function onDocumentKeyDown(event) {
            if (event.keyCode == 37) {
                fetchProduct('PREV');
            } else if (event.keyCode == 39) {
                fetchProduct('NEXT');
            } else if (event.keyCode == 27) {
                resetPosition();
            }
            
        };
        
        function resetPosition() {
            gsap.to(camera.position,{
                duration:3,
                x : -1,
                y:  6,
                z:  30,
                onUpdate: function() {
                    camera.lookAt( new THREE.Vector3(selecttionCoordinates.x,selecttionCoordinates.y,selecttionCoordinates.z) );
                }
            });
        };

        function fetchProduct(direction){
            let nextIndex;
            if (direction === 'NEXT') {
                nextIndex = (currentProductIndex + 1) > 4 ? 0 :  (currentProductIndex + 1);
            } else if (direction === 'PREV'){
                nextIndex = (currentProductIndex - 1) < 0 ? 4 :  (currentProductIndex - 1);
            }
            
            nextProductName = Object.keys(standing_position)[nextIndex];
            
            gsap.to(camera.position,{
                    duration:3,
                    x : standing_position[nextProductName].x,
                    y:  standing_position[nextProductName].y,
                    z:  standing_position[nextProductName].z,
                    onUpdate: function() {
                        if (nextProductName ==='C210R-001' || nextProductName ==='C210R-002') {
                            camera.lookAt( new THREE.Vector3(-200,0,0) );
                        } else {
                            camera.lookAt( new THREE.Vector3(200,0,0) );
                        }
                        
                    }
                });
            currentProductIndex = nextIndex;
        }

        document.addEventListener( 'resize', onWindowResize );

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

        }

        
    </script>
</body>

</html>